version: "3.8"

services:
  web2gif:
    image: ghcr.io/puppeteer/puppeteer:latest
    container_name: web2gif
    user: root                      # nÃ©cessaire pour apt-get dans le conteneur
    working_dir: /app
    ports:
      - "9786:8080"                 # => http://<ip>:9786
    environment:
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
      NODE_ENV: production
    shm_size: "2gb"                 # important pour Chrome headless
    volumes:
      - ./:/app                     # le code du repo est montÃ© dans /app
    command: >
      sh -c "
        apt-get update &&
        apt-get install -y --no-install-recommends ffmpeg &&
        rm -rf /var/lib/apt/lists/* &&
        (npm ci --omit=dev || npm i --omit=dev) &&
        node server.js
      "
    restart: unless-stopped
